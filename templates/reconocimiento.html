<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reconocimiento Facial</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="estilos/estilos.css">
</head>
<body>
    <div style="display: flex; flex-direction: column; align-items: center;">
        <div class="texto-bienvenida">
            ¡Sonríe! Te reconoceré.
        </div>
        <div style="position: relative; display: inline-block;">
            <video id="camara-video" autoplay playsinline></video>
            <div class="ia-encima">
                <img src="imagenes/IA.png" alt="Cara de la IA">
            </div>
        </div>
        <div class="mensaje-error" id="mensaje-error"></div>
    </div>

    <br><br>

    <a href="registro.html">
        <button>Registrar nuevo estudiante</button>
    </a>

    <div class="logo-inferior">
        <img src="imagenes/logo_uni.png" alt="Logo de la Universidad">
    </div>

    <script>
        const videoElement = document.getElementById('camara-video');
        const mensajeError = document.getElementById('mensaje-error');
        const backendUrl = 'https://tu-backend.onrender.com'; //  <-  URL de Render

        async function iniciarCamara() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = stream;
                setInterval(enviarFotograma, 100); // Enviar fotogramas al backend
            } catch (error) {
                console.error("Error al acceder a la cámara:", error);
                mensajeError.textContent = "No se pudo acceder a la cámara. Asegúrate de que esté conectada y los permisos estén habilitados.";
                videoElement.style.display = 'none';
            }
        }

        async function enviarFotograma() {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            const imageDataUrl = canvas.toDataURL('image/jpeg');

            try {
                const response = await fetch(`${backendUrl}/reconocer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageDataUrl })
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }

                const data = await response.json();
                console.log(data); // Manejar la respuesta del backend
                if (data.estado === 'reconocido') {
                    mensajeError.textContent = `¡Reconocido! Estudiante: ${data.nombre}`;
                    // Aquí podrías mostrar un mensaje, registrar la asistencia, etc.
                } else {
                    mensajeError.textContent = 'Rostro no reconocido';
                }

            } catch (error) {
                console.error("Error al enviar fotograma:", error);
                mensajeError.textContent = "Error al enviar fotograma al servidor.";
            }
        }

        iniciarCamara();
    </script>
</body>
</html>